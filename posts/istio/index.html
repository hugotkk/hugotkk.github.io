<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Istio Note | Hugo</title><meta name=keywords content="k8s,service-mesh,istio"><meta name=description content="Main concept Injecting a proxy in front of each pods - so we can do traffic management
Traffic Shifting Fault Injection Circuit Breaking Mirror and apply security features
mtls between pods security policy or some logging / auditing works
Imagine there is a proxy server in front of each pod.
VirtualService and DestinationRule are the configure of the proxy server
Actually the offical documentation is good enough. here is a good course to learn about istio."><meta name=author content="Hugo"><link rel=canonical href=https://hugotkk.github.io/posts/istio/><link crossorigin=anonymous href=/assets/css/stylesheet.min.6cba0d81b5f3f42bb578d49f402ba4175aa72b43def148780b8ad714c957c6f5.css integrity="sha256-bLoNgbXz9Cu1eNSfQCukF1qnK0Pe8Uh4C4rXFMlXxvU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://hugotkk.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hugotkk.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hugotkk.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hugotkk.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hugotkk.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.3"><meta property="og:title" content="Istio Note"><meta property="og:description" content="Main concept Injecting a proxy in front of each pods - so we can do traffic management
Traffic Shifting Fault Injection Circuit Breaking Mirror and apply security features
mtls between pods security policy or some logging / auditing works
Imagine there is a proxy server in front of each pod.
VirtualService and DestinationRule are the configure of the proxy server
Actually the offical documentation is good enough. here is a good course to learn about istio."><meta property="og:type" content="article"><meta property="og:url" content="https://hugotkk.github.io/posts/istio/"><meta property="og:image" content="https://hugotkk.github.io/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-06T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hugotkk.github.io/papermod-cover.png"><meta name=twitter:title content="Istio Note"><meta name=twitter:description content="Main concept Injecting a proxy in front of each pods - so we can do traffic management
Traffic Shifting Fault Injection Circuit Breaking Mirror and apply security features
mtls between pods security policy or some logging / auditing works
Imagine there is a proxy server in front of each pod.
VirtualService and DestinationRule are the configure of the proxy server
Actually the offical documentation is good enough. here is a good course to learn about istio."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hugotkk.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Istio Note","item":"https://hugotkk.github.io/posts/istio/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Istio Note","name":"Istio Note","description":"Main concept Injecting a proxy in front of each pods - so we can do traffic management\nTraffic Shifting Fault Injection Circuit Breaking Mirror and apply security features\nmtls between pods security policy or some logging / auditing works\nImagine there is a proxy server in front of each pod.\nVirtualService and DestinationRule are the configure of the proxy server\nActually the offical documentation is good enough. here is a good course to learn about istio.","keywords":["k8s","service-mesh","istio"],"articleBody":"Main concept Injecting a proxy in front of each pods - so we can do traffic management\nTraffic Shifting Fault Injection Circuit Breaking Mirror and apply security features\nmtls between pods security policy or some logging / auditing works\nImagine there is a proxy server in front of each pod.\nVirtualService and DestinationRule are the configure of the proxy server\nActually the offical documentation is good enough. here is a good course to learn about istio.\nIstio Settings min tls protocol memory and cpu limit on istiod - I use this to reduce the memory limit on istiod. The default profile is 2G memory by default. block un-registry egress by default - See Service Entry dns proxing - See Service Entry enable egress gateway Install Multicluster Setup Guide\nThe Before you Begin section is important. For Multi-Primary Multicluster, we need to generate a root certificate to issue the certificates for cluster1 and cluster2. See Configure Trust\nMulti-primary: istiod on each cluster Primary-remote: only primary will have istiod - remote will share the istiod with primary On different networks: the pods are in different networks at 2 k8s clusters. EKS support vpc networking, the pods can be in the vpc subnet so the pods in different cluster can be configured on the same network. I have set up 2 k3s clusters on aws ec2. The pods are on different networks. Install VM Workload istio can bring VM into the service mesh. treat vm as a k8s pod\nWorkload Entry: Pod Workload Group: Deployment Service Entry: Service I follow this guide to set this up\nThere are few options for the installation. I chose\nMulti Network - as the vm and k8s pods are in different networks (For example: vm 192.168.0.1/24 k8s pods 10.0.1.0/24. In AWS, we pods can use the aws vpc network which mean if we have a subnet 192.168.0.1/24 both vm and eks pods can be in same subnet) Automated WorkloadEntry Creation - workload entry will automatically create after joining the mesh dns Before the installation, we need to setup a dns server first. VM need to know about the k8s cluster (*.cluster.local eg: httpbin.default.svc.cluster.local).\nHere are some notes on setting up dnsmasq on ec2.\n/etc/dnsmasq.conf\nbind-interfaces listen-address=127.0.0.1 server=169.254.169.254 address=/cluster.local// bind-interfaces + listen-address make the dns server work. bind-interfaces will bind port 53 on all interfaces but listen-address will restrict it on specific interface need to forward queries to aws’s dns (169.254.169.254) /etc/resolv.conf\nnameserver 127.0.0.1 update resolv.conf to tell the vm to use the dnsmasq\nFor ubuntu, the resolv.conf will be managed by systemd-resolved so it is better to disable it\nsystemctl disable systemd-resolved systemctl stop systemd-resolved system-resolved will create a symbolic link to /etc/resolv.conf. When systemd-resolved is disable, the resolv.conf may disappear after the server restart. So be careful of that.\nInstall with revision If istio is installed with the canary method, the istiod service name will be different.\nwithout revision: istiod.istio-system.svc.cluster.local with revision: istiod-.istio-system.svc.cluster.local The templates at Expose services inside the cluster via the east-west gateway are using istiod.istio-system.svc so we have to change it manually\nAlso we have to add --revision when deploy the east west gateway\nService vs ServiceEntry the vm can be selected with Service - ServiceEntry is not necessary If we want to use ServiceEntry, DNS proxy need to be enabled Upgrade In-placed run istioctl upgrade with the updated istioctl binary\nCanary For example, we want to upgrade istio from 1.13.0 to 1.14.3.\nWe can\ninstall new version (let 2 versions coexist) switch to new version uninstall the old version Firstly, istio has to be installed with --revision\nistioctl operator init --revision 1-13-0 and apply IstioOperator config with specific revision\nspec: ... revision: 1-13-0 To enable auto injection in namespace (example is default), instead of\nkubectl label ns default istio-injection=enabled we have to specify the revision\nkubectl label ns default istio.io/rev=1-13-0 To upgrade istio:\nDownload 1.14.3 istioctl binary init 1.14.3 operator istioctl operator init --revision 1-14-3 apply IstiOperator config with revision: 1-14-3 Update injection label - kubectl label ns default istio.io/rev=1-14-3 --overwrite Uninstall the old version - istioctl x uninstall --revision 1-13-0 Sidecar injection cannot enable globally - not like mTLS - need to be apply per namespace / per pod hostNetwork: true in pod will stop the injection injection can be override in pod level Service Entry This is confusing me so much.\nWhy the hostname resolution does not work? My expectation: like k8s’ service but it’s for external services - so we are adding an A record to the k8s DNS\nFor example:\napiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: mysql spec: hosts: - db.hhuge9.com location: MESH_EXTERNAL endpoints: - XXXXX Expected that I can connect to my own mysql service with mysql -h db.hhuge9.com at any pod in the mesh after apply this config\nBut the result is - db.hhuge9.com cannot be resolved\nThe reason is - ServiceEntry will not do anything on the dns unless we enable the DNS proxying feature\nWhen we apply this ServiceEntry\napiVersion: networking.istio.io/v1alpha3 kind: ServiceEntry metadata: name: google spec: hosts: - google.hhuge9.com location: MESH_EXTERNAL resolution: DNS endpoints: - 142.250.200.14 with enabling dns proxying:\nISTIO_META_DNS_CAPTURE: true - will add entry to k8s dns. google.hhuge9.com will be resolved with the endpoints ips (142.250.200.14) ISTIO_META_DNS_AUTO_ALLOCATE: true - will allocate an internal ip (like service in k8s). google.hhuge9.com will be resolve with that ips We can leave ISTIO_META_DNS_AUTO_ALLOCATE: false and assign an internal ip at the addresses field\n... hosts: - google.hhuge9.com addresses: - 192.168.0.1 ... endpoints: - 142.250.200.14 Therefore nslookup google.hhuge9.com will return 192.168.0.1\nBut for the host name resolution, we need ISTIO_META_DNS_CAPTURE: true\nIs it just a canonical name / A record? I doubted why ServiceEntry is needed. We can access the service directly without applying a config, right? It looks so useless\nAcutualy, It becomes useful when we want to control the egress traffic When the REGISTRY_ONLY policy is enabled, only registered services can be accessed within the mesh. Therefore, a service entry of facebook.com will be needed if we want to access facebook inside the pod\nAuthorizationPolicy Useful examples can be found on Concept \u003e Security \u003e Authorization policies and Reference \u003e Security \u003e AuthorizationPolicy Best practise is applying allow-nothing first then apply our policies allow-all and deny-all are useful in debug apiVersion: security.istio.io/v1beta1 kind: AuthorizationPolicy metadata: name: httpbin namespace: foo spec: selector: matchLabels: app: httpbin version: v1 action: ALLOW rules: - from: - source: principals: [\"cluster.local/ns/default/sa/sleep\"] - source: namespaces: [\"dev\"] to: - operation: methods: [\"GET\"] when: - key: request.header[foo] values: [\"bar\"] This policy means - allow access to the pod in namespace foo with label httpbin and v1 with the existence of\nGET request and foo: bar header and the source is from namespace dev or with principals cluster.local/ns/default/sa/sleep principal: cluster.local/ns/default/sa/sleep means sleep.default.svc.cluster.local. It is the service account name when the mtls is enabled\nThe account name can be confirmed by printing out the environment variables with env in the pod\nIngress Gateway http https - tls termination on proxy https - tls termination on pod (tls passthrough) Egress Gateway http https initial the request with http but connect to the target with https Traffic Management Most of the examples can be found on here\nFault Injection - like: return 500 / add delay to the requests Traffic Shifting - eg: 50% to v1; 50% to v2 - good for canary / blue green deployment / AB testing Circuit Breaking - exclude the pods if face consecutive 5XX error / set max connections Mirror - mirror the traffic. good for logging / testing / monitoring ","wordCount":"1250","inLanguage":"en","datePublished":"2022-09-06T00:00:00Z","dateModified":"2022-09-06T00:00:00Z","author":[{"@type":"Person","name":"Hugo"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://hugotkk.github.io/posts/istio/"},"publisher":{"@type":"Organization","name":"Hugo","logo":{"@type":"ImageObject","url":"https://hugotkk.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://hugotkk.github.io/ accesskey=h title="Hugo (Alt + H)">Hugo</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://hugotkk.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://hugotkk.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hugotkk.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hugotkk.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://hugotkk.github.io/posts/>Posts</a></div><h1 class=post-title>Istio Note</h1><div class=post-meta>September 6, 2022&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Hugo</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#main-concept aria-label="Main concept">Main concept</a></li><li><a href=#istio-settings aria-label="Istio Settings">Istio Settings</a></li><li><a href=#install-multicluster aria-label="Install Multicluster">Install Multicluster</a></li><li><a href=#install-vm-workload aria-label="Install VM Workload">Install VM Workload</a><ul><li><a href=#dns aria-label=dns>dns</a></li><li><a href=#install-with-revision aria-label="Install with revision">Install with revision</a></li><li><a href=#service-vs-serviceentry aria-label="Service vs ServiceEntry">Service vs ServiceEntry</a></li></ul></li><li><a href=#upgrade aria-label=Upgrade>Upgrade</a><ul><li><a href=#in-placed aria-label=In-placed>In-placed</a></li><li><a href=#canary aria-label=Canary>Canary</a></li></ul></li><li><a href=#sidecar-injection aria-label="Sidecar injection">Sidecar injection</a></li><li><a href=#service-entry aria-label="Service Entry">Service Entry</a><ul><li><a href=#why-the-hostname-resolution-does-not-work aria-label="Why the hostname resolution does not work?">Why the hostname resolution does not work?</a></li><li><a href=#is-it-just-a-canonical-name--a-record aria-label="Is it just a canonical name / A record?">Is it just a canonical name / A record?</a></li></ul></li><li><a href=#authorizationpolicy aria-label=AuthorizationPolicy>AuthorizationPolicy</a></li><li><a href=#ingress-gateway aria-label="Ingress Gateway">Ingress Gateway</a></li><li><a href=#egress-gateway aria-label="Egress Gateway">Egress Gateway</a></li><li><a href=#traffic-management aria-label="Traffic Management">Traffic Management</a></li></ul></div></details></div><div class=post-content><h1 id=main-concept>Main concept<a hidden class=anchor aria-hidden=true href=#main-concept>#</a></h1><p>Injecting a proxy in front of each pods - so we can do traffic management</p><ul><li>Traffic Shifting</li><li>Fault Injection</li><li>Circuit Breaking</li><li>Mirror</li></ul><p>and apply security features</p><ul><li>mtls between pods</li><li>security policy</li></ul><p>or some logging / auditing works</p><p>Imagine there is a proxy server in front of each pod.</p><p>VirtualService and DestinationRule are the configure of the proxy server</p><p>Actually the offical documentation is good enough. here is a good
<a href=https://www.udemy.com/course/istio-hands-on-for-kubernetes/>course</a> to learn about istio.</p><h1 id=istio-settings>Istio Settings<a hidden class=anchor aria-hidden=true href=#istio-settings>#</a></h1><ul><li><a href=https://istio.io/latest/docs/tasks/security/tls-configuration/workload-min-tls-version/>min tls protocol</a></li><li><a href=https://istio.io/latest/docs/setup/additional-setup/customize-installation/#customize-kubernetes-settings>memory and cpu limit on istiod</a> - I use this to reduce the memory limit on istiod. The default profile is 2G memory by default.</li><li><a href=https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/#change-to-the-blocking-by-default-policy>block un-registry egress by default</a> - See Service Entry</li><li><a href=https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/>dns proxing</a> - See Service Entry</li><li><a href=https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/#deploy-istio-egress-gateway>enable egress gateway</a></li></ul><h1 id=install-multicluster>Install Multicluster<a hidden class=anchor aria-hidden=true href=#install-multicluster>#</a></h1><p><a href=https://istio.io/latest/docs/setup/install/multicluster/>Setup Guide</a></p><p>The <code>Before you Begin</code> section is important. For Multi-Primary Multicluster, we need to generate a root certificate to issue the certificates for cluster1 and cluster2. See <a href=https://istio.io/latest/docs/setup/install/multicluster/before-you-begin>Configure Trust</a></p><ul><li>Multi-primary: istiod on each cluster</li><li>Primary-remote: only primary will have istiod - remote will share the istiod with primary</li><li>On different networks: the pods are in different networks at 2 k8s clusters. EKS support <a href=https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html>vpc networking</a>, the pods can be in the vpc subnet so the pods in different cluster can be configured on the same network. I have set up 2 k3s clusters on aws ec2. The pods are on different networks.</li></ul><h1 id=install-vm-workload>Install VM Workload<a hidden class=anchor aria-hidden=true href=#install-vm-workload>#</a></h1><p>istio can bring VM into the service mesh. treat vm as a k8s pod</p><ul><li>Workload Entry: Pod</li><li>Workload Group: Deployment</li><li>Service Entry: Service</li></ul><p>I follow this <a href=https://istio.io/latest/docs/setup/install/virtual-machine/>guide</a> to set this up</p><p>There are few options for the installation. I chose</p><ul><li>Multi Network - as the vm and k8s pods are in different networks (For example: vm 192.168.0.1/24 k8s pods 10.0.1.0/24. In AWS, we pods can use the aws vpc network which mean if we have a subnet 192.168.0.1/24 both vm and eks pods can be in same subnet)</li><li>Automated WorkloadEntry Creation - <code>workload entry</code> will automatically create after joining the mesh</li></ul><h2 id=dns>dns<a hidden class=anchor aria-hidden=true href=#dns>#</a></h2><p>Before the installation, we need to setup a dns server first. VM need to know about the k8s cluster (*.cluster.local eg: httpbin.default.svc.cluster.local).</p><p>Here are some notes on setting up dnsmasq on ec2.</p><p>/etc/dnsmasq.conf</p><pre tabindex=0><code>bind-interfaces
listen-address=127.0.0.1
server=169.254.169.254
address=/cluster.local/&lt;k8s_cluster_ip&gt;/
</code></pre><ul><li>bind-interfaces + listen-address make the dns server work. bind-interfaces will bind port 53 on all interfaces but listen-address will restrict it on specific interface</li><li>need to forward queries to aws&rsquo;s dns (169.254.169.254)</li></ul><p>/etc/resolv.conf</p><pre tabindex=0><code>nameserver 127.0.0.1
</code></pre><p>update resolv.conf to tell the vm to use the dnsmasq</p><p>For ubuntu, the resolv.conf will be managed by systemd-resolved so it is better to disable it</p><pre tabindex=0><code>systemctl disable systemd-resolved
systemctl stop systemd-resolved
</code></pre><p>system-resolved will create a symbolic link to /etc/resolv.conf. When systemd-resolved is disable, the resolv.conf may disappear after the server restart. So be careful of that.</p><h2 id=install-with-revision>Install with revision<a hidden class=anchor aria-hidden=true href=#install-with-revision>#</a></h2><p>If istio is installed with the canary method, the istiod service name will be different.</p><ul><li>without revision: istiod.istio-system.svc.cluster.local</li><li>with revision: istiod-&lt;revision>.istio-system.svc.cluster.local</li></ul><p>The templates at <code>Expose services inside the cluster via the east-west gateway</code> are using istiod.istio-system.svc so we have to change it manually</p><p>Also we have to add <code>--revision</code> when deploy the east west gateway</p><h2 id=service-vs-serviceentry>Service vs ServiceEntry<a hidden class=anchor aria-hidden=true href=#service-vs-serviceentry>#</a></h2><ul><li>the vm can be selected with Service - ServiceEntry is not necessary</li><li>If we want to use ServiceEntry, <a href=https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/>DNS proxy</a> need to be enabled</li></ul><h1 id=upgrade>Upgrade<a hidden class=anchor aria-hidden=true href=#upgrade>#</a></h1><h2 id=in-placed>In-placed<a hidden class=anchor aria-hidden=true href=#in-placed>#</a></h2><p>run <code>istioctl upgrade</code> with the updated <code>istioctl</code> binary</p><h2 id=canary>Canary<a hidden class=anchor aria-hidden=true href=#canary>#</a></h2><p>For example, we want to upgrade istio from 1.13.0 to 1.14.3.</p><p>We can</p><ul><li>install new version (let 2 versions coexist)</li><li>switch to new version</li><li>uninstall the old version</li></ul><p>Firstly, istio has to be installed with <code>--revision</code></p><pre tabindex=0><code>istioctl operator init --revision 1-13-0
</code></pre><p>and apply <code>IstioOperator</code> config with specific revision</p><pre tabindex=0><code>spec:
...
  revision: 1-13-0
</code></pre><p>To enable auto injection in namespace (example is <code>default</code>), instead of</p><pre tabindex=0><code>kubectl label ns default istio-injection=enabled
</code></pre><p>we have to specify the revision</p><pre tabindex=0><code>kubectl label ns default istio.io/rev=1-13-0
</code></pre><p>To upgrade istio:</p><ul><li>Download 1.14.3 istioctl binary</li><li>init 1.14.3 operator <code>istioctl operator init --revision 1-14-3</code></li><li>apply IstiOperator config with <code>revision: 1-14-3</code></li><li>Update injection label - <code>kubectl label ns default istio.io/rev=1-14-3 --overwrite</code></li><li>Uninstall the old version - <code>istioctl x uninstall --revision 1-13-0</code></li></ul><h1 id=sidecar-injection>Sidecar injection<a hidden class=anchor aria-hidden=true href=#sidecar-injection>#</a></h1><ul><li>cannot enable globally - not like <a href=https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#globally-enabling-istio-mutual-tls-in-strict-mode>mTLS</a> - need to be apply <a href=https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#controlling-the-injection-policy>per namespace / per pod</a></li><li><code>hostNetwork: true</code> <a href=https://istio.io/latest/docs/ops/common-problems/injection/>in pod</a> will stop the injection</li><li>injection can be override in pod level</li></ul><h1 id=service-entry>Service Entry<a hidden class=anchor aria-hidden=true href=#service-entry>#</a></h1><p>This is confusing me so much.</p><h2 id=why-the-hostname-resolution-does-not-work>Why the hostname resolution does not work?<a hidden class=anchor aria-hidden=true href=#why-the-hostname-resolution-does-not-work>#</a></h2><p>My expectation: like k8s&rsquo; service but it&rsquo;s for external services - so we are adding an A record to the k8s DNS</p><p>For example:</p><pre tabindex=0><code>apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: mysql
spec:
  hosts:
  - db.hhuge9.com
  location: MESH_EXTERNAL
  endpoints:
  - XXXXX
</code></pre><p>Expected that I can connect to my own mysql service with <code>mysql -h db.hhuge9.com</code> at any pod in the mesh after apply this config</p><p>But the result is - <code>db.hhuge9.com</code> cannot be resolved</p><p>The reason is - <code>ServiceEntry</code> will not do anything on the dns unless we enable the <a href=https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/>DNS proxying</a> feature</p><p>When we apply this <code>ServiceEntry</code></p><pre tabindex=0><code>apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: google
spec:
  hosts:
  - google.hhuge9.com
  location: MESH_EXTERNAL
  resolution: DNS
  endpoints:
  - 142.250.200.14
</code></pre><p>with enabling dns proxying:</p><ul><li><code>ISTIO_META_DNS_CAPTURE: true</code> - will add entry to k8s dns. <code>google.hhuge9.com</code> will be resolved with the endpoints ips (<code>142.250.200.14</code>)</li><li><code>ISTIO_META_DNS_AUTO_ALLOCATE: true</code> - will allocate an internal ip (like service in k8s). <code>google.hhuge9.com</code> will be resolve with that ips</li></ul><p>We can leave <code>ISTIO_META_DNS_AUTO_ALLOCATE: false</code> and assign an internal ip at the addresses field</p><pre tabindex=0><code>...
  hosts:
  - google.hhuge9.com
  addresses:
  - 192.168.0.1
  ...
  endpoints:
  - 142.250.200.14
</code></pre><p>Therefore nslookup <code>google.hhuge9.com</code> will return <code>192.168.0.1</code></p><p>But for the host name resolution, we need <code>ISTIO_META_DNS_CAPTURE: true</code></p><h2 id=is-it-just-a-canonical-name--a-record>Is it just a canonical name / A record?<a hidden class=anchor aria-hidden=true href=#is-it-just-a-canonical-name--a-record>#</a></h2><p>I doubted why <code>ServiceEntry</code> is needed. We can access the service directly without applying a config, right? It looks so useless</p><p>Acutualy, It becomes useful when we want to <a href=https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/#change-to-the-blocking-by-default-policy>control the egress traffic</a></p><p>When the <code>REGISTRY_ONLY</code> policy is enabled, only registered services can be accessed within the mesh. Therefore, a service entry of <code>facebook.com</code> will be needed if we want to access facebook inside the pod</p><h1 id=authorizationpolicy>AuthorizationPolicy<a hidden class=anchor aria-hidden=true href=#authorizationpolicy>#</a></h1><ul><li>Useful examples can be found on <a href=https://istio.io/latest/docs/concepts/security/#authorization-policies>Concept > Security > Authorization policies</a> and <a href=https://istio.io/latest/docs/reference/config/security/authorization-policy/>Reference > Security > AuthorizationPolicy</a></li><li>Best practise is applying <code>allow-nothing</code> first then apply our policies</li><li><code>allow-all</code> and <code>deny-all</code> are useful in debug</li></ul><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: httpbin
 namespace: foo
spec:
 selector:
   matchLabels:
     app: httpbin
     version: v1
 action: ALLOW
 rules:
 - from:
   - source:
       principals: [&#34;cluster.local/ns/default/sa/sleep&#34;]
   - source:
       namespaces: [&#34;dev&#34;]
   to:
   - operation:
       methods: [&#34;GET&#34;]
   when:
   - key: request.header[foo]
     values: [&#34;bar&#34;]
</code></pre><p>This policy means - allow access to the pod in namespace <code>foo</code> with label <code>httpbin</code> and <code>v1</code> with the existence of</p><ul><li>GET request and</li><li>foo: bar header and the source is</li><li>from namespace <code>dev</code> or</li><li>with principals <code>cluster.local/ns/default/sa/sleep</code></li></ul><p><code>principal: cluster.local/ns/default/sa/sleep</code> means <code>sleep.default.svc.cluster.local</code>. It is the service account name when the mtls is enabled</p><p>The account name can be confirmed by printing out the environment variables with <code>env</code> in the pod</p><h1 id=ingress-gateway>Ingress Gateway<a hidden class=anchor aria-hidden=true href=#ingress-gateway>#</a></h1><ul><li><a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/>http</a></li><li><a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/>https - tls termination on proxy</a></li><li><a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-sni-passthrough/>https - tls termination on pod</a> (tls passthrough)</li></ul><h1 id=egress-gateway>Egress Gateway<a hidden class=anchor aria-hidden=true href=#egress-gateway>#</a></h1><ul><li><a href=https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/#egress-gateway-for-http-traffic>http</a></li><li><a href=https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/#egress-gateway-for-https-traffic>https</a></li><li><a href=https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/>initial the request with http but connect to the target with https</a></li></ul><h1 id=traffic-management>Traffic Management<a hidden class=anchor aria-hidden=true href=#traffic-management>#</a></h1><p>Most of the examples can be found on <a href=https://istio.io/latest/docs/tasks/traffic-management/>here</a></p><ul><li>Fault Injection - like: return 500 / add delay to the requests</li><li>Traffic Shifting - eg: 50% to v1; 50% to v2 - good for canary / blue green deployment / AB testing</li><li>Circuit Breaking - exclude the pods if face consecutive 5XX error / set max connections</li><li>Mirror - mirror the traffic. good for logging / testing / monitoring</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://hugotkk.github.io/tags/k8s/>k8s</a></li><li><a href=https://hugotkk.github.io/tags/service-mesh/>service-mesh</a></li><li><a href=https://hugotkk.github.io/tags/istio/>istio</a></li></ul><nav class=paginav><a class=next href=https://hugotkk.github.io/posts/hyperledger-fabric/><span class=title>Next Page »</span><br><span>Hyperledger fabric</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Istio Note on twitter" href="https://twitter.com/intent/tweet/?text=Istio%20Note&url=https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f&hashtags=k8s%2cservice-mesh%2cistio"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Istio Note on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f&title=Istio%20Note&summary=Istio%20Note&source=https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Istio Note on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f&title=Istio%20Note"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Istio Note on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Istio Note on whatsapp" href="https://api.whatsapp.com/send?text=Istio%20Note%20-%20https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Istio Note on telegram" href="https://telegram.me/share/url?text=Istio%20Note&url=https%3a%2f%2fhugotkk.github.io%2fposts%2fistio%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://hugotkk.github.io/>Hugo</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>